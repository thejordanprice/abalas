<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Simple Static Server</title>
  </head>
  <body>
    <h2>Simple Static Server</h2>
    <p>Server is running on http://0.0.0.0:8080</p>
    <p>The folder being served is ./www</p>
    <p id='impressions'></p>
  </body>
  <script>
    /**
     * Fetch stats api.
     **/
    const fetchImpressions = () => {
      let element = document.getElementById('impressions');
      fetch('http://127.0.0.1:8080/api/count')
      .then((res) => {
        let text = res.text();
        return text;
      })
      .then((text) => {
        element.innerHTML = "Impressions: " + text;
      });
    };

    fetchImpressions();

    const timer = setInterval(() => {
      fetchImpressions();
    }, 5000);


    /**
     * Our express server.
     **/
    require('./renderer.js');

    const express = require('express');
    const app = express();

    let count = 0;

    app.get('/api/count', (req, res) => {
      res.send(count.toString());
    });

    app.use((req, res, next) => {
      count++;
      res.locals.ip = req.headers['x-forwarded-for'] || req.connection.remoteAddress;
      console.log('FROM: ' + res.locals.ip + ' ON: ' + req.originalUrl);
      next();
    });

    app.use(express.static('www'));

    app.listen(8080, function () {
      console.log('Server is listening on http://0.0.0.0:8080')
    });

  </script>
</html>
